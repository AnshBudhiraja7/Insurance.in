<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
</head>
<style>
    .menu
{
    float: left;
    font-size: 30px;
    background-color: slateblue;
    padding: 10px;
    margin: 0px 0.5px;
    color: white;
    cursor: pointer;
}
a
{
    text-decoration: none;
    color: white;
}
a:hover{
    color: chartreuse;
}
#row
{
    text-align: center;
    display: flex;
    justify-content: center;
}
</style>
<body>

    <div id='row' class="container">
        <div class="menu"><a href="Detaling.html">Display Inqueries</a></div>
        <div class="menu"><a href="Appro.html">Approved</a></div>
        <div class="menu"><a href="Today'sss.html">Show Today's</a></div>
        <div class="menu"><a href="index.html">LogOut</a></div>
    </div>
    <div class="container">
        <h1 style="text-align: center;">Inqueries</h1>
        <hr><br>
        <input type="text" class="form-control" id="Search" style="width: 40%; display: inline;" onkeyup="Search()"
            placeholder="Search by Name">
        <select class="form-control" style="width: 15%; display: inline;" onchange="Filter()" id="filter">
            <option>All</option>
            <option>Last Month</option>
            <option>This Month</option>
        </select>
        <select class="form-control" style="width: 15%; display: inline;" id="itype" onchange="Filter1()">
            <option>All</option>
            <option>Life Insurance</option>
            <option>Health Insurance</option>
            <option>Motor Insurance</option>
        </select>
        <button class="btn btn-success" onclick="Excel()">Convert to Excel</button>
        <button class="btn btn-danger" onclick="Delete()">Delete All</button>
        <button class="btn btn-primary" onclick="Fetch()">Fetch Detail</button> 
        <br>
        <br>
        <br>
        <table class="table">
            <thead>
                <th>S.No.</th>
                <th>Name</th>
                <th>Phone Number</th>
                <th>Email</th>
                <th>Address</th>
                <th>Date(DD/MM/YYYY) & Time</th>
                <th>Insurance Type</th>
                <th>Operation</th>
            </thead>
            <tbody id="tbody">

            </tbody>
        </table>
        <br>
        <br>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-storage.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDt_Fj3J-kixtXeTj3cKNLulyuDDPDKWys",
            authDomain: "insurance-f28df.firebaseapp.com",
            projectId: "insurance-f28df",
            storageBucket: "insurance-f28df.appspot.com",
            messagingSenderId: "838660135539",
            appId: "1:838660135539:web:8ac502243554407e492806"
        };


        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        Show()
        var KeyArr = []
        function Delete() {
            firebase.database().ref("/Inquiry/").remove()
            alert("Data Deleted")
            Show()
        }
        function Show() {
            document.getElementById("tbody").innerHTML = ""
            firebase.database().ref('/Inquiry/').on("value", function (AllObj) {
                Obj = AllObj.val()
                if (Obj == null) {
                    alert("No data found. Try again Later.")
                    window.location.href = "Login.html"
                }
                else {
                    KeyArr = Object.keys(Obj)
                    document.getElementById("tbody").innerHTML = ""
                    KeyArr.reverse().map(function (key, index) {
                        Table(index, Obj[key].Name, Obj[key].Phone, Obj[key].Email, Obj[key].Address, Obj[key].Timing, Obj[key].Type, Obj[key].Rc);
                    })
                    Approving()
                }
            })
        }
        function Table(index, name, phone, email, address, timing, type, rc) {
            var row = document.createElement("tr")
            var cell1 = document.createElement("td")
            var cell2 = document.createElement("td")
            var cell3 = document.createElement("td")
            var cell4 = document.createElement("td")
            var cell5 = document.createElement("td")
            var cell6 = document.createElement("td")
            var cell7 = document.createElement("td")
            var cell8 = document.createElement("td")


            cell1.innerHTML = index + 1
            cell2.innerHTML = name
            cell3.innerHTML = phone
            cell4.innerHTML = email
            cell5.innerHTML = address
            cell6.innerHTML = timing
            cell7.innerHTML = type

            delbtn = document.createElement("button")
            delbtn.innerHTML = "Delete"
            delbtn.className = "btn btn-danger"
            delbtn.id = index
            delbtn.setAttribute("onclick", "Del(this)")
            cell8.append(delbtn)



            App = document.createElement("button")
            App.innerHTML = "Approve"
            App.className = "btn btn-danger"
            App.id = index
            App.setAttribute("onclick", "Approve(this)")
            cell8.append(App)




            row.append(cell1)
            row.append(cell2)
            row.append(cell3)
            row.append(cell4)
            row.append(cell5)
            row.append(cell6)
            row.append(cell7)
            row.append(cell8)
            document.getElementById("tbody").append(row)
        }
        function Approve(Obutton) {
            Obutton.className = "btn btn-success"
            Obutton.innerHTML = "Approved"
            key = KeyArr[Obutton.id]
            dbtn = (Obutton.parentNode.childNodes[0])
            dbtn.style.display = "none"
            firebase.database().ref("/Inquiry/").on("value", function (snap) {
                Obj = snap.val()
                obj = Obj[key]
                firebase.database().ref("/Customer/" + key).set(obj)
            })

        }
        function Approving() {
            var Arr = []
            firebase.database().ref("/Customer/").on("value", function (Snap) {
                Obj = Snap.val()
                if (Obj == null) {
                    alert("No Inquery Approved")
                }
                else {
                    key = Object.keys(Obj)
                    key.map(function (e) {
                        Arr.push(e)
                    })
                }


            })

            setTimeout(function () {
                firebase.database().ref("/Inquiry/").on("value", function (snap) {
                    obj = snap.val()
                    Allkey = Object.keys(obj)
                    Allkey.reverse().map(function (i, index) {
                        Arr.map(function (ii) {
                            if (i == ii) {
                                table = (document.getElementById("tbody").childNodes)
                                for (i = 0; i < table.length; i++) {
                                    btn = table[i].childNodes[7].childNodes[1]
                                    if (btn.id == index) {
                                        dbtn = (btn.parentNode.childNodes[0])
                                        dbtn.style.display = "none"
                                        btn.className = "btn btn-success"
                                        btn.innerHTML = "Approved"
                                    }
                                }
                            }
                        })
                    })
                })
            }, 500)
        }
        function Del(Obutton) {
            key = KeyArr[Obutton.id]
            firebase.database().ref('/Inquiry/' + key).remove()
            Show()
        }
        function Excel() {
            // Variable to store the final csv data
            var csv_data = [];

            // Get each row data
            var rows = document.getElementsByTagName('tr');
            for (var i = 0; i < rows.length; i++) {

                // Get each column data
                var cols = rows[i].querySelectorAll('td,th');

                // Stores each csv row data
                var csvrow = [];
                for (var j = 0; j < cols.length - 1; j++) {

                    // Get the text data of each cell
                    // of a row and push it to csvrow
                    csvrow.push(cols[j].innerHTML);
                }

                // Combine each column value with comma
                csv_data.push(csvrow.join(","));
            }

            // Combine each row data with new line character
            csv_data = csv_data.join('\n');

            // Call this function to download csv file 
            downloadCSVFile(csv_data);

        }

        function downloadCSVFile(csv_data) {

            // Create CSV file object and feed
            // our csv_data into it
            CSVFile = new Blob([csv_data], {
                type: "text/csv"
            });

            // Create to temporary link to initiate
            // download process
            var temp_link = document.createElement('a');

            // Download csv file
            temp_link.download = "GfG.csv";
            var url = window.URL.createObjectURL(CSVFile);
            temp_link.href = url;

            // This link should not be displayed
            temp_link.style.display = "none";
            document.body.appendChild(temp_link);

            // Automatically click the link to
            // trigger download
            temp_link.click();
            document.body.removeChild(temp_link);
        }
        function Search() {
            var Search = document.getElementById("Search").value
            firebase.database().ref('/Inquiry/').on("value", function (AllObj) {
                Obj = AllObj.val()
                if (Obj == null) {
                    alert("No data found")
                    window.location.href = "Login.html"
                }
                else {
                    if (Search == "") {
                        Show()
                    }
                    else {
                        document.getElementById("tbody").innerHTML = ""
                        KeyArr = Object.keys(Obj)
                        KeyArr.map(function (key, index) {
                            if (Obj[key].Name.match(Search)) {
                                Table(index, Obj[key].Name, Obj[key].Phone, Obj[key].Email, Obj[key].Address, Obj[key].Timing, Obj[key].Type, Obj[key].Rc);
                            }

                        })
                    }
                }
            })
        }
        function Filter1() {
            document.getElementById("tbody").innerHTML = ""
            var itype = document.getElementById("itype").value
            if (itype == "All") {
                Show()
            }
            else {
                firebase.database().ref('/Inquiry/').on("value", function (AllObj) {
                    Obj = AllObj.val()
                })
                KeyArr = Object.keys(Obj)
                KeyArr.map(function (key, index) {
                    if (itype == Obj[key].Type) {
                        Table(index, Obj[key].Name, Obj[key].Phone, Obj[key].Email, Obj[key].Address, Obj[key].Timing, Obj[key].Type, Obj[key].Rc);
                    }
                })
            }
        }
        function Filter() {
            document.getElementById("tbody").innerHTML = ""
            var filter = document.getElementById("filter").value
            if (filter == "All") {
                Show()
            }
            else if (filter == "This Month") {
                var d = new Date()
                var month = d.getMonth() + 1
                firebase.database().ref('/Inquiry/').on("value", function (AllObj) {
                    Obj = AllObj.val()
                    KeyArr = Object.keys(Obj)
                    KeyArr.map(function (key, index) {
                        var newarr = Obj[key].Timing.split("&")
                        var montharr = (newarr[0].split("/"))
                        if (month == montharr[1]) {
                            Table(index, Obj[key].Name, Obj[key].Phone, Obj[key].Email, Obj[key].Address, Obj[key].Timing, Obj[key].Type, Obj[key].Rc);
                        }
                    })
                })
            }
            else if (filter == "Last Month") {
                var d = new Date()
                var month = d.getMonth()
                firebase.database().ref('/Inquiry/').on("value", function (AllObj) {
                    Obj = AllObj.val()
                    KeyArr = Object.keys(Obj)
                    KeyArr.map(function (key, index) {
                        var newarr = Obj[key].Timing.split("&")
                        var montharr = (newarr[0].split("/"))
                        if (month == montharr[1]) {
                            Table(index, Obj[key].Name, Obj[key].Phone, Obj[key].Email, Obj[key].Address, Obj[key].Timing, Obj[key].Type, Obj[key].Rc);
                        }
                    })
                })
            }
            else {
                alert("No data found")
            }
        }
        function Fetch() {
            firebase.database().ref("/Fetch/").remove()
            setInterval(function () {
                Move()
            }, 1000)
        }
        function Move() {
            window.location.href = "Fetchh.html"
        }
    </script>
</body>

</html>